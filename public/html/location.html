



<!DOCTYPE html>
<html>
<head>
    <title>Find OCBC Bank Branches and ATMs</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
        }
        #map {
            height: 60vh;
            width: 100%;
        }
        #locations {
            padding: 10px;
            max-height: 40vh;
            overflow-y: auto;
            background: #f9f9f9;
            border-top: 1px solid #ccc;
        }
        .location-item {
            margin-bottom: 10px;
        }
        .transport-info {
            margin-top: 5px;
            padding: 10px;
            background: #f1f1f1;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .step {
            border: 1px solid #ddd;
            margin-bottom: 10px;
            padding: 10px;
            border-radius: 5px;
            background: #f9f9f9;
        }

        .step-header {
            display: flex;
            justify-content: space-between;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .step-number {
            color: #007bff;
        }

        .step-details {
            font-size: 14px;
            color: #555;
        }

        .step-mode {
            background: #007bff;
            color: #fff;
            padding: 2px 5px;
            border-radius: 3px;
        }

    </style>
</head>
<body>
    <div id="map"></div>
    <div id="locations">
        <h3>Nearby OCBC Bank Branches and ATMs</h3>
        <div id="location-list"></div>
    </div>
    <script>
        let map, userLocation;

        const staticLocations = [
            { name: "OCBC Branch - Choa Chu Kang", lat: 1.3856, lng: 103.7441 },
        ];

        const oneMapToken = "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJodHRwOi8vaW50ZXJuYWwtYWxiLW9tLXByZGV6aXQtaXQtbmV3LTE2MzM3OTk1NDIuYXAtc291dGhlYXN0LTEuZWxiLmFtYXpvbmF3cy5jb20vYXBpL3YyL3VzZXIvcGFzc3dvcmQiLCJpYXQiOjE3MzY2MjA3NjcsImV4cCI6MTczNjg3OTk2NywibmJmIjoxNzM2NjIwNzY3LCJqdGkiOiJtcmdRek9OcDlrTGt2ejY1Iiwic3ViIjoiZjY4ZTY4YTQ5ZjJkZWJhYzhiZWRiNzc2MWQ3YzdhMTYiLCJ1c2VyX2lkIjo1NTc1LCJmb3JldmVyIjpmYWxzZX0.g1Ce7A2SNFekQ3r0iPPx46bsXCAa9QzkLPcF5HO0nZM"; // Replace with your OneMap API token

        function haversine(lat1, lon1, lat2, lon2) {
            const R = 6371; // Earth's radius in km
            const dLat = ((lat2 - lat1) * Math.PI) / 180;
            const dLon = ((lon2 - lon1) * Math.PI) / 180;
            const a = 
                Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos((lat1 * Math.PI) / 180) *
                Math.cos((lat2 * Math.PI) / 180) *
                Math.sin(dLon / 2) *
                Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        function initMap() {
            map = L.map('map').setView([1.3521, 103.8198], 12); // Default to Singapore

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: 'Â© OpenStreetMap contributors',
            }).addTo(map);

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        userLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude,
                        };

                        map.setView(userLocation, 15);
                        L.marker(userLocation).addTo(map).bindPopup("You are here").openPopup();

                        findNearbyLocations(userLocation);
                    },
                    (error) => {
                        console.error("Geolocation error:", error.message);
                        alert("Could not get your location.");
                    }
                );
            } else {
                alert("Geolocation is not supported by this browser.");
            }
        }

        function findNearbyLocations(location) {
            const { lat, lng } = location;
            const query = `https://nominatim.openstreetmap.org/search?format=json&limit=10&q=OCBC&lat=${lat}&lon=${lng}&radius=5000`;

            fetch(query)
                .then(response => response.json())
                .then(data => {
                    const locations = [
                        ...data.map(result => ({
                            name: result.display_name.split(",")[0], // Extract main name
                            address: result.display_name.split(",").slice(1).join(",").trim(), // Extract address
                            lat: parseFloat(result.lat),
                            lng: parseFloat(result.lon),
                        })),
                        ...staticLocations.map(staticLoc => ({
                            ...staticLoc,
                            address: "Choa Chu Kang, Singapore", // Static address for static locations
                        })),
                    ];

                    locations.forEach(location => {
                        location.distance = haversine(lat, lng, location.lat, location.lng);
                    });

                    // Filter locations within 5km radius
                    const filteredLocations = locations.filter(loc => loc.distance <= 5);

                    // Sort by distance
                    filteredLocations.sort((a, b) => a.distance - b.distance);

                    displayLocations(filteredLocations);
                })
                .catch(error => {
                    console.error("Error fetching locations:", error);
                    alert("Could not fetch locations.");
                });
        }

        function displayLocations(locations) {
            const locationList = document.getElementById("location-list");
            locationList.innerHTML = "";

            locations.forEach((location, index) => {
                L.marker([location.lat, location.lng], {
                    icon: L.icon({
                        iconUrl: 'https://cdn-icons-png.flaticon.com/512/684/684908.png',
                        iconSize: [25, 41],
                        iconAnchor: [12, 41],
                        popupAnchor: [0, -30],
                    }),
                }).addTo(map).bindPopup(`${location.name}<br>${location.address}<br>${location.distance.toFixed(2)} km away`);

                const locationItem = document.createElement("div");
                locationItem.className = "location-item";
                locationItem.innerHTML = `
                    <strong>${location.name}</strong><br>
                    <span>${location.address}</span><br>
                    <span>${location.distance.toFixed(2)} km away</span><br>
                    <button onclick="fetchTransportInfo(${location.lat}, ${location.lng}, ${index})">Get Public Transport Info</button>
                    <div id="transport-${index}" class="transport-info"></div>
                `;
                locationList.appendChild(locationItem);
            });
        }

        function findNearestMRT(lat, lng, callback) {
            const mrtQueryUrl = `https://www.onemap.gov.sg/api/common/elastic/search?searchVal=MRT&returnGeom=Y&getAddrDetails=N&pageNum=1`;

            fetch(mrtQueryUrl, {
                method: "GET",
                headers: {
                    Authorization: `Bearer ${oneMapToken}`,
                },
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.results) {
                        let nearestStation = null;
                        let minDistance = Infinity;

                        data.results.forEach((station) => {
                            const stationLat = parseFloat(station.LATITUDE);
                            const stationLng = parseFloat(station.LONGITUDE);
                            const distance = haversine(lat, lng, stationLat, stationLng);

                            if (distance < minDistance) {
                                minDistance = distance;
                                nearestStation = {
                                    name: station.SEARCHVAL,
                                    lat: stationLat,
                                    lng: stationLng,
                                };
                            }
                        });

                        callback(nearestStation);
                    } else {
                        callback(null);
                    }
                })
                .catch(error => {
                    console.error("Error fetching MRT stations:", error);
                    callback(null);
                });
        }

        function fetchTransportInfo(destinationLat, destinationLng, index) {
            if (!userLocation) {
                alert("User location is not available.");
                return;
            }

            const transportInfo = document.getElementById(`transport-${index}`);
            transportInfo.innerHTML = "Fetching transport options...";

            // Fetch the route directly from user location to the destination
            fetchRoute(`${userLocation.lat},${userLocation.lng}`, `${destinationLat},${destinationLng}`, index);
        }

        function fetchRoute(start, end, index) {
            if (start === end) {
                console.error("Start and end coordinates are identical. Routing is not meaningful.");
                return;
            }

            const now = new Date();
            const formattedDate = now.toLocaleDateString('en-US', {
                month: '2-digit',
                day: '2-digit',
                year: 'numeric',
            }).replace(/\//g, '-');
            const formattedTime = now
                .toTimeString()
                .split(' ')[0]
                .replace(/:/g, '');

            const routeUrl = `https://www.onemap.gov.sg/api/public/routingsvc/route?start=${start}&end=${end}&routeType=pt&date=${formattedDate}&time=${formattedTime}&mode=TRANSIT&maxWalkDistance=1000&numItineraries=1`;

            fetch(routeUrl, {
                method: 'GET',
                headers: {
                    Authorization: `Bearer ${oneMapToken}`,
                },
            })
                .then((response) => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                })
                .then((data) => {
                    const transportInfo = document.getElementById(`transport-${index}`);
                    const itinerary = data.plan.itineraries[0]; // Assuming the first itinerary is the best one
                    if (itinerary) {
                        const durationMinutes = Math.ceil(itinerary.duration / 60);
                        const walkDistanceMeters = Math.round(itinerary.walkDistance);
                        const steps = itinerary.legs.map((leg, index) => {
                            return `
                                <div class="step">
                                    <div class="step-header">
                                        <span class="step-number">Step ${index + 1}:</span>
                                        <span class="step-mode">${leg.mode}</span>
                                    </div>
                                    <div class="step-details">
                                        <p><strong>Start:</strong> ${leg.from.name || 'Unknown'}</p>
                                        <p><strong>End:</strong> ${leg.to.name || 'Unknown'}</p>
                                        <p><strong>Distance:</strong> ${Math.round(leg.distance)} meters</p>
                                        <p><strong>Time:</strong> ${new Date(leg.startTime).toLocaleTimeString()} - ${new Date(leg.endTime).toLocaleTimeString()}</p>
                                    </div>
                                </div>
                            `;
                        }).join('');


                        transportInfo.innerHTML = `
                            <p><strong>Total Duration:</strong> ${durationMinutes} minutes</p>
                            <p><strong>Total Walking Distance:</strong> ${walkDistanceMeters} meters</p>
                            <p>Steps:</p>
                            <ul>${steps}</ul>
                        `;
                    } else {
                        transportInfo.innerHTML = "No route found.";
                    }
                })
                .catch((error) => {
                    console.error("Error fetching route:", error);
                    const transportInfo = document.getElementById(`transport-${index}`);
                    transportInfo.innerHTML = "Could not fetch transport information.";
                });
        }







        initMap();
    </script>
</body>
</html>
